

**Post-Push Full Audit Verdict (Phase 8)**
- Full post-push Phase 8 audit completed.
- One additional functional gap was identified and remediated in this pass.
- No remaining material Phase 8 gaps are open.

**Audit Focus**
- Auth + RBAC + API-key scope behavior (`ingest/jobs` only for machine scope).
- WebSocket token enforcement (JWT or API key query token).
- `/ask` contract requirements (mandatory `confidence`, structured sources/recommendations).
- Per-farm rate limiting semantics across all farm-scoped routes.
- End-to-end regression impact (Python + Julia full suites).

**Newly Identified Gap (Resolved)**
- Gap: per-farm rate limiting did not apply to ingest routes because `farm_id` is carried in request body (not path).
- Root cause: middleware only extracted `farm_id` from path params/path regex.
- Remediation:
  - Added async extraction path for ingest payloads in `app/auth/dependencies.py` (`extract_request_farm_id_async`).
  - Updated `app/middleware/rate_limit.py` to use async farm-id extraction.
  - Added regression test: `tests/test_auth.py::test_rate_limit_applies_to_ingest_body_farm_id`.

**Validation Evidence (Post-Remediation)**
- `python -m pytest /workspace/agrisense/tests/test_auth.py -x --asyncio-mode=auto` → `7 passed`
- `python -m pytest /workspace/agrisense/tests -x --asyncio-mode=auto` → `46 passed`
- `cd /workspace/agrisense/core/AgriSenseCore && julia --project=. -e 'using Pkg; Pkg.test()'` → `562 passed`

**Status**
- Phase 8 passes a full post-push audit after remediation.
- Security, contract, websocket auth, and per-farm rate-limiting behaviors are now aligned with the agreed decisions.
